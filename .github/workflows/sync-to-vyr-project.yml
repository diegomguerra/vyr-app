name: Sync VYR app -> VYR project (front only)

on:
  push:
    branches:
      - main
      - work
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source (vyr-app)
        uses: actions/checkout@v4

      - name: Checkout target (vyr-project)
        uses: actions/checkout@v4
        with:
          repository: diegomguerra/vyr-project
          token: ${{ secrets.SYNC_TOKEN }}
          path: target
          ref: main

      - name: Sync front-end (preserve native folders)
        run: |
          set -e

          rsync -av --delete --exclude ".git/" --exclude ".github/" ./src/ target/src/
          rsync -av --delete --exclude ".git/" --exclude ".github/" ./public/ target/public/

          if [ -d "./supabase" ]; then
            mkdir -p target/supabase
            rsync -av --delete ./supabase/ target/supabase/
          fi

          cp -f ./index.html target/index.html
          cp -f ./package.json target/package.json

          for f in vite.config.ts vite.config.js vercel.json tailwind.config.ts tailwind.config.js postcss.config.js eslint.config.js components.json tsconfig.json tsconfig.app.json tsconfig.node.json .gitignore .env.example README.md; do
            if [ -f "./$f" ]; then
              cp -f "./$f" "target/$f"
            fi
          done

      - name: Commit and push changes
        id: sync_commit
        run: |
          cd target
          git config user.name "vyr-sync-bot"
          git config user.email "vyr-sync-bot@users.noreply.github.com"

          BRANCH="sync/vyrapp-${{ github.sha }}"
          git checkout -b "$BRANCH"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to sync."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          git commit -m "Sync front from vyr-app (source ${{ github.sha }})"
          git push origin "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create PR in vyr-project
        if: steps.sync_commit.outputs.has_changes == 'true'
        run: |
          cd target
          gh pr create \
            --title "Sync front from vyr-app (source ${{ github.sha }})" \
            --body "Automated sync from vyr-app. Native code preserved." \
            --base main \
            --head "${{ env.BRANCH }}"
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
